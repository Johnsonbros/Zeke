services:
  db:
    image: postgres:16
    container_name: zeke_db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-zeke}
      POSTGRES_USER: ${POSTGRES_USER:-zeke}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?set in .env}
    volumes:
      - zeke_db_data:/var/lib/postgresql/data
    ports:
      # Optional: expose DB for debugging (comment out for tighter security)
      - "127.0.0.1:${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 3s
      retries: 20

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: zeke_app
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      # Required
      DATABASE_URL: ${DATABASE_URL:-postgresql://${POSTGRES_USER:-zeke}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB:-zeke}}
      OPENAI_API_KEY: ${OPENAI_API_KEY:?set in .env}
      JWT_SECRET: ${JWT_SECRET:?set in .env}

      # Recommended
      SESSION_SECRET: ${SESSION_SECRET:-}
      APP_NAME: ${APP_NAME:-ZEKE}
      APP_ENV: ${APP_ENV:-production}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      PORT: ${PORT:-5000}

      # Optional integrations
      DEEPGRAM_API_KEY: ${DEEPGRAM_API_KEY:-}
      OMI_API_KEY: ${OMI_API_KEY:-}
      OMI_DEV_API_KEY: ${OMI_DEV_API_KEY:-}
      OMI_MCP_API_KEY: ${OMI_MCP_API_KEY:-}
      OMI_COMMANDS_ENABLED: ${OMI_COMMANDS_ENABLED:-false}

      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID:-}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN:-}
      TWILIO_PHONE_NUMBER: ${TWILIO_PHONE_NUMBER:-}
      MASTER_ADMIN_PHONE: ${MASTER_ADMIN_PHONE:-}

      INTERNAL_BRIDGE_KEY: ${INTERNAL_BRIDGE_KEY:-}
      EXPORT_SECRET_TOKEN: ${EXPORT_SECRET_TOKEN:-}
      OVERLAND_ACCESS_TOKEN: ${OVERLAND_ACCESS_TOKEN:-}

      MORNING_BRIEFING_ENABLED: ${MORNING_BRIEFING_ENABLED:-false}
      MORNING_BRIEFING_PHONE: ${MORNING_BRIEFING_PHONE:-}

      # Tuning
      DB_WAIT_TIMEOUT_MS: ${DB_WAIT_TIMEOUT_MS:-60000}

    ports:
      # Expose HTTP API + web UI
      # If you only want local access, change to 127.0.0.1:5000:5000
      - "${PORT:-5000}:5000"

volumes:
  zeke_db_data:
