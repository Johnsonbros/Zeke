# ZEKE Backend Issue: Chat API Endpoint `/api/conversations` Returns HTML Instead of JSON

## Issue Summary
The ZEKE mobile companion app is unable to connect to the chat feature because `POST /api/conversations` returns the HTML homepage instead of a JSON response with the conversation ID.

## Technical Details

**Endpoint:** `POST https://zekeai.replit.app/api/conversations`

**Request from mobile app:**
```
POST /api/conversations
Headers:
  Content-Type: application/json
  X-ZEKE-Device-Token: <device_token>
Body:
  { "title": "Chat with ZEKE" }
```

**Expected Response:**
```json
{
  "id": "conversation_uuid",
  "title": "Chat with ZEKE",
  "createdAt": "2024-12-18T..."
}
```

**Actual Response (HTTP 200):**
```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>ZEKE - Personal AI Assistant</title>
    ...
```

## Root Cause Analysis
The backend is serving the SPA fallback (index.html) instead of processing the API route. This typically happens when:
1. The `/api/conversations` route is not defined in the Express/backend router
2. The route exists but is defined after the SPA catch-all handler
3. The API routes are not properly mounted

## Recommended Fix
Check `server/routes.ts` or equivalent and ensure:

### 1. Add the conversations API routes (if missing):
```typescript
// Conversations routes
app.get("/api/conversations", authMiddleware, async (req, res) => {
  const conversations = await storage.getConversations(req.userId);
  res.json(conversations);
});

app.post("/api/conversations", authMiddleware, async (req, res) => {
  const { title } = req.body;
  const conversation = await storage.createConversation({
    userId: req.userId,
    title: title || "New Conversation"
  });
  res.status(201).json(conversation);
});

app.get("/api/conversations/:id/messages", authMiddleware, async (req, res) => {
  const messages = await storage.getConversationMessages(req.params.id);
  res.json(messages);
});

app.post("/api/conversations/:id/messages", authMiddleware, async (req, res) => {
  const message = await storage.addMessage(req.params.id, req.body);
  res.status(201).json(message);
});
```

### 2. Ensure API routes are registered BEFORE SPA fallback:
```typescript
// API routes FIRST
registerApiRoutes(app);

// SPA catch-all LAST
app.get("*", (req, res) => {
  res.sendFile("index.html");
});
```

### 3. Accept X-ZEKE-Device-Token header for mobile authentication
The mobile app authenticates using the `X-ZEKE-Device-Token` header instead of cookies. Ensure your auth middleware checks for this header:

```typescript
function authMiddleware(req, res, next) {
  // Check cookie auth (web)
  const sessionToken = req.cookies?.session;
  
  // Check device token auth (mobile)
  const deviceToken = req.headers['x-zeke-device-token'];
  
  if (sessionToken) {
    // Validate session token...
  } else if (deviceToken) {
    // Validate device token...
  } else {
    return res.status(401).json({ error: "Authentication required" });
  }
  
  next();
}
```

## Verification
After implementing the fix, test with:
```bash
curl -X POST https://zekeai.replit.app/api/conversations \
  -H "Content-Type: application/json" \
  -H "X-ZEKE-Device-Token: YOUR_DEVICE_TOKEN" \
  -d '{"title":"Test Conversation"}'
```

**Expected:** JSON response with conversation ID
**Current:** HTML page content

## Additional Context

### Working Endpoints (for reference)
These endpoints work correctly and return JSON:
- `GET /api/tasks` - Returns `{"tasks":[],"source":"zeke-backend"}`
- `GET /api/grocery` - Returns `{"items":[...]}`

### Mobile App Flow
1. User opens Chat tab in mobile app
2. App calls `POST /api/conversations` to create a new conversation
3. Backend should return `{ id: "conv_xxx", ... }`
4. App uses conversation ID for subsequent message calls
5. Currently fails at step 3 because HTML is returned

### Request Headers Being Forwarded
The mobile app proxy forwards these headers to the ZEKE backend:
- `cookie`
- `authorization`
- `x-api-key`
- `x-user-id`
- `x-session-id`
- `x-request-id`
- `user-agent`
- `x-zeke-device-token`

## Contact
This prompt was generated by the ZEKE Mobile Companion App (Replit Agent) to help debug the chat connectivity issue.
